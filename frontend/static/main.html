<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Absensi Intern</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
  <!-- <script src="auth.js"></script> -->
</head>
<body class="flex h-screen bg-white">
<!-- <script>checkAuth();</script> -->

<!-- Sidebar -->
<aside class="w-64 sidebar flex flex-col items-start py-8 px-6 space-y-6 shadow-lg">
  <div class="text-2xl font-bold mb-4 self-center">
    <span class="text-center block mt-2">ADMIN</span>
  </div>
  <nav class="w-full flex flex-col gap-4 text-white font-medium text-base">
    <a href="main.html" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg sidebar-link active">
      <span>🏠</span> <span>Dashboard</span>
    </a>
    <a href="data.html" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg sidebar-link">
      <span>🧑‍💼</span> <span>List Data Intern</span>
    </a>
    <a href="daftarhadir.html" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg sidebar-link">
      <span>🧾</span> <span>Daftar Hadir</span>
    </a>
    <button onclick="signOut()" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg bg-white text-red-700 hover:bg-red-100 font-semibold transition">
      <span>🚪</span> <span>Sign Out</span>
    </button>
  </nav>
</aside>

<!-- Main Content -->
<main class="flex-1 p-8 overflow-y-auto main-content">
  <h1 class="text-3xl font-bold text-red-700 mb-6">📈 Dashboard</h1>
  
  <!-- Statistik Utama -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="stat-card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-700">Total Kehadiran</h2>
        <span class="text-2xl">📊</span>
      </div>
      <p id="totalAttendance" class="text-4xl text-red-600 font-bold">-</p>
      <p class="text-sm text-gray-500 mt-2">Sesi kehadiran bulan ini</p>
    </div>
    
    <div class="stat-card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-700">Intern Aktif</h2>
        <span class="text-2xl">👥</span>
      </div>
      <p id="activeInterns" class="text-4xl text-green-600 font-bold">-</p>
      <p class="text-sm text-gray-500 mt-2">Intern yang absen hari ini</p>
    </div>

    <div class="stat-card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-700">Hari Aktif</h2>
        <span class="text-2xl">📅</span>
      </div>
      <p id="activeDays" class="text-4xl text-blue-600 font-bold">-</p>
      <p class="text-sm text-gray-500 mt-2">Total hari dengan absensi</p>
    </div>

    <div class="stat-card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-700">Rata-rata/Hari</h2>
        <span class="text-2xl">📈</span>
      </div>
      <p id="avgDaily" class="text-4xl text-purple-600 font-bold">-</p>
      <p class="text-sm text-gray-500 mt-2">Rata-rata kehadiran per hari</p>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="stat-card p-6">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">🚀 Quick Actions</h2>
      <div class="space-y-3">
        <a href="daftarhadir.html" class="block w-full p-3 bg-blue-500 text-white rounded-lg text-center hover:bg-blue-600 transition">
          📊 Lihat Total Kehadiran Bulan
        </a>
        <a href="data.html" class="block w-full p-3 bg-green-500 text-white rounded-lg text-center hover:bg-green-600 transition">
          👥 Lihat Intern Aktif Hari Ini
        </a>
        <button onclick="viewWeeklyData()" class="block w-full p-3 bg-purple-500 text-white rounded-lg text-center hover:bg-purple-600 transition">
          📅 Lihat Data Absensi Seminggu
        </button>
      </div>
    </div>

    <div class="stat-card p-6">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">📋 Informasi Sistem</h2>
      <div class="space-y-3">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="text-gray-600">Sistem Aktif Sejak:</span>
          <span id="systemStartDate" class="font-medium">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="text-gray-600">Tanggal Hari Ini:</span>
          <span id="currentDate" class="font-medium">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="text-gray-600">Status Auto-Reset:</span>
          <span id="resetStatus" class="font-medium text-green-600">🟢 Aktif</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="text-gray-600">Face Recognition:</span>
          <span class="font-medium text-blue-600">🤖 Aktif</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Today's Active Interns Preview -->
  <div class="stat-card p-6 mt-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">👥 Intern Aktif Hari Ini (Preview)</h2>
    <div id="activeInternsPreview" class="space-y-3">
      <div class="text-center text-gray-500 py-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-700 mx-auto mb-4"></div>
        <p>Memuat data intern aktif...</p>
      </div>
    </div>
    <div class="text-center mt-4">
      <a href="data.html" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
        👁️ Lihat Detail Lengkap →
      </a>
    </div>
  </div>
</main>

<!-- Toast Container -->
<div id="toastContainer" class="fixed bottom-6 right-6 space-y-2 z-50"></div>

<script>
  const BACKEND_URL = 'http://127.0.0.1:8000'; // Sesuaikan dengan port backend Anda
  const START_DATE_API = `${BACKEND_URL}/api/system-start-date`;

  // Update dashboard statistics when page loads
  window.onload = function() {
    loadDashboardData();
    loadSystemInfo();
    loadActiveInternsPreview();
  };

  function viewWeeklyData() {
    window.location.href = 'daftarhadir.html';
  }

  async function loadDashboardData() {
    try {
      // Load current month data
      const now = new Date();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear();
      
      // Statistik bulanan
      const monthlyResponse = await fetch(`${BACKEND_URL}/api/monthly-attendance/${currentYear}/${currentMonth}`);
      const monthlyData = await monthlyResponse.json();
      if (!monthlyData.error) {
        document.getElementById('totalAttendance').textContent = monthlyData.total_attendance;
        document.getElementById('avgDaily').textContent = monthlyData.avg_daily_attendance;
      }
      // Statistik total hari aktif (sepanjang sistem aktif)
      const rangeResponse = await fetch(`${BACKEND_URL}/api/attendance-dates-with-range`);
      const rangeData = await rangeResponse.json();
      if (!rangeData.error) {
        document.getElementById('activeDays').textContent = rangeData.total_dates;
      }
      // Load today's active interns
      const activeResponse = await fetch(`${BACKEND_URL}/api/today-active-interns`);
      const activeData = await activeResponse.json();
      if (!activeData.error) {
        document.getElementById('activeInterns').textContent = activeData.total_active;
      }
    } catch (error) {
      console.error('Error loading dashboard data:', error);
    }
  }

  async function loadSystemInfo() {
    try {
      const response = await fetch(`${BACKEND_URL}/api/system-start-date`);
      const data = await response.json();
      
      const startDate = new Date(data.system_start_date);
      const currentDate = new Date(data.current_date);
      
      const formattedStartDate = startDate.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
      
      const formattedCurrentDate = currentDate.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
      
      document.getElementById('systemStartDate').textContent = formattedStartDate;
      document.getElementById('currentDate').textContent = formattedCurrentDate;
      
    } catch (error) {
      console.error('Error loading system info:', error);
    }
  }

  async function loadActiveInternsPreview() {
    try {
      const response = await fetch(`${BACKEND_URL}/api/today-active-interns`);
      const data = await response.json();
      
      if (data.error) {
        console.error('Error:', data.error);
        return;
      }
      
      const container = document.getElementById('activeInternsPreview');
      if (data.active_interns.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500 py-4">
            <p>📝 Belum ada intern yang absen hari ini</p>
          </div>
        `;
      } else {
        // Tampilkan maksimal 3 intern untuk preview
        const previewInterns = data.active_interns.slice(0, 3);
        container.innerHTML = previewInterns.map(intern => `
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
            <!-- Capture Image -->
            <div class="flex-shrink-0">
              ${intern.capture_image ? `
                <div class="w-12 h-12 rounded-lg overflow-hidden border border-blue-200">
                  <img src="${intern.capture_image}" alt="Capture ${intern.name}" 
                       class="w-full h-full object-cover" 
                       onerror="this.src='https://via.placeholder.com/48x48/blue/white?text=📷'">
                </div>
              ` : `
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                  <span class="text-blue-600 text-lg">📷</span>
                </div>
              `}
            </div>
            
            <!-- Info -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <h4 class="font-medium text-gray-800 text-sm">${intern.name}</h4>
                <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">
                  ✓
                </span>
              </div>
              <p class="text-xs text-gray-500">${intern.jobdesk} • ⏰ ${new Date(intern.recognition_time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</p>
            </div>
          </div>
        `).join('');
        // Jika ada lebih dari 3 intern, tambahkan indikator
        if (data.active_interns.length > 3) {
          container.innerHTML += `
            <div class="text-center text-gray-500 py-2">
              <p class="text-sm">+${data.active_interns.length - 3} intern lainnya</p>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('Error loading active interns preview:', error);
    }
  }

  function signOut() {
    window.location.href = "main.html";
  }
</script>
</body>
</html>