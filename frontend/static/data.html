<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>List Data Intern - Absensi Intern</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/daisyui"></script> -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
  <!-- <script src="auth.js"></script> -->
</head>
<body class="flex h-screen bg-white">
<!-- <script>checkAuth();</script> -->

<!-- Sidebar -->
<aside class="w-64 sidebar flex flex-col items-start py-8 px-6 space-y-6 shadow-lg">
  <div class="text-2xl font-bold mb-4 self-center">
    <span class="text-center block mt-2">ADMIN</span>
  </div>
  <nav class="w-full flex flex-col gap-4 text-white font-medium text-base">
    <a href="main.html" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg sidebar-link">
      <span>üè†</span> <span>Dashboard</span>
    </a>
    <a href="data.html" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg sidebar-link active">
      <span>üßë‚Äçüíº</span> <span>List Data Intern</span>
    </a>
    <a href="daftarhadir.html" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg sidebar-link">
      <span>üßæ</span> <span>Daftar Hadir</span>
    </a>
    <button onclick="signOut()" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg bg-white text-red-700 hover:bg-red-100 font-semibold transition">
      <span>üö™</span> <span>Sign Out</span>
    </button>
  </nav>
</aside>

<!-- Main Content -->
<main class="flex-1 p-8 overflow-y-auto main-content">
  <h1 class="text-3xl font-bold text-red-700 mb-6">üßë‚Äçüíº List Data Intern</h1>
  
  <!-- Status Card -->
  <div class="stat-card p-6 space-y-4 mb-6">
    <h2 class="text-xl font-semibold text-gray-700">üìä Status Sistem</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="text-center p-4 bg-blue-50 rounded-lg">
        <div class="text-2xl font-bold text-blue-600" id="totalDates">-</div>
        <div class="text-sm text-gray-600">Total Hari Aktif</div>
      </div>
      <div class="text-center p-4 bg-green-50 rounded-lg">
        <div class="text-2xl font-bold text-green-600" id="todayAttendees">-</div>
        <div class="text-sm text-gray-600">Absen Hari Ini</div>
      </div>
      <div class="text-center p-4 bg-purple-50 rounded-lg">
        <div class="text-2xl font-bold text-purple-600" id="systemStartDate">-</div>
        <div class="text-sm text-gray-600">Mulai Sistem</div>
      </div>
      <div class="text-center p-4 bg-yellow-50 rounded-lg">
        <div class="text-2xl font-bold text-yellow-600" id="activeInternsCount">-</div>
        <div class="text-sm text-gray-600">Intern Aktif</div>
      </div>
    </div>
  </div>

  <!-- Today's Active Interns Card -->
  <div class="stat-card p-6 space-y-4 mb-6">
    <h2 class="text-xl font-semibold text-gray-700">üë• Intern Aktif Hari Ini</h2>
    <div class="text-center p-4 bg-yellow-50 rounded-lg mb-4">
      <div class="text-2xl font-bold text-yellow-600" id="activeInternsCount">-</div>
      <div class="text-sm text-gray-600">Intern yang sudah absen hari ini</div>
      <div class="text-xs text-gray-500 mt-1">Data akan reset setiap pukul 00:00</div>
    </div>
    <div id="activeInternsList" class="space-y-4">
      <div class="text-center text-gray-500 py-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-700 mx-auto mb-4"></div>
        <p>Memuat data intern aktif...</p>
      </div>
    </div>
  </div>

  <input id="absensiSearchList" type="text" placeholder="üîç Cari absensi intern..." class="form-input mt-6" oninput="filterAbsensiList()" />
  <div id="absensiList" class="space-y-4 mt-4">
    <div class="text-center text-gray-500 py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-700 mx-auto mb-4"></div>
      <p>Memuat data absensi...</p>
    </div>
  </div>
</main>

<!-- Toast Container -->
<div id="toastContainer" class="fixed bottom-6 right-6 space-y-2 z-50"></div>

<script>
  const BACKEND_URL = 'http://127.0.0.1:8000'; // Sesuaikan dengan IP backend Anda
  const ACTIVE_INTERNS_API = `${BACKEND_URL}/api/today-active-interns`; 

  let attendanceData = [];

  // Initialize the UI
  window.onload = function() {
    loadAttendanceData();
    loadSystemStatus();
    loadActiveInterns();
  };

  async function loadSystemStatus() {
    try {
      // Load attendance summary for today
      const summaryResponse = await fetch(`${BACKEND_URL}/api/attendance-summary`);
      const summaryData = await summaryResponse.json();
      
      document.getElementById('todayAttendees').textContent = summaryData.total_attendees || 0;
      
      // Load system start date
      const startDateResponse = await fetch(`${BACKEND_URL}/api/system-start-date`);
      const startDateData = await startDateResponse.json();
      
      const startDate = new Date(startDateData.system_start_date);
      const formattedStartDate = startDate.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
      document.getElementById('systemStartDate').textContent = formattedStartDate;
      
    } catch (error) {
      console.error('Error loading system status:', error);
    }
  }

  async function loadActiveInterns() {
    try {
      const response = await fetch(`${BACKEND_URL}/api/today-active-interns`);
      const data = await response.json();
      
      if (data.error) {
        console.error('Error:', data.error);
        return;
      }
      
      document.getElementById('activeInternsCount').textContent = data.total_active;
      
      const container = document.getElementById('activeInternsList');
      if (data.active_interns.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500 py-4">
            <p>üìù Belum ada intern yang absen hari ini</p>
            <p class="text-sm mt-2">Data akan reset setiap pukul 00:00</p>
          </div>
        `;
      } else {
        container.innerHTML = data.active_interns.map(intern => `
          <div class="bg-white border rounded-lg p-4 shadow-sm">
            <div class="flex items-start gap-4">
              <!-- Capture Image -->
              <div class="flex-shrink-0">
                ${intern.capture_image ? `
                  <div class="w-20 h-20 rounded-lg overflow-hidden border-2 border-blue-200">
                    <img src="${intern.capture_image}" alt="Capture ${intern.name}" 
                         class="w-full h-full object-cover" 
                         onerror="this.src='https://via.placeholder.com/80x80/blue/white?text=üì∑'">
                  </div>
                ` : `
                  <div class="w-20 h-20 bg-blue-100 rounded-lg flex items-center justify-center">
                    <span class="text-blue-600 text-2xl">üì∑</span>
                  </div>
                `}
              </div>
              
              <!-- Intern Info -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2">
                  <h4 class="font-semibold text-gray-800 text-lg">${intern.name}</h4>
                  <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">
                    ‚úì Terdeteksi
                  </span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                  <div>
                    <span class="text-gray-500">Sistem Label:</span>
                    <span class="font-medium text-gray-700 ml-1">${intern.name}</span>
                  </div>
                  <div>
                    <span class="text-gray-500">Divisi:</span>
                    <span class="font-medium text-blue-600 ml-1">${intern.jobdesk}</span>
                  </div>
                  <div>
                    <span class="text-gray-500">Jobdesk:</span>
                    <span class="font-medium text-gray-700 ml-1">${intern.jobdesk}</span>
                  </div>
                  <div>
                    <span class="text-gray-500">Waktu Absen:</span>
                    <span class="font-medium text-green-600 ml-1">‚è∞ ${new Date(intern.recognition_time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                  </div>
                </div>
                
                <div class="mt-2 text-xs text-gray-500">
                  <span>üïê Deteksi: ${new Date(intern.recognition_time).toLocaleString('id-ID')}</span>
                </div>
              </div>
              
              <!-- Status Badge -->
              <div class="flex-shrink-0">
                <div class="text-right">
                  <div class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium mb-2">
                    Aktif Hari Ini
                  </div>
                  <div class="text-xs text-gray-500">
                    ID: ${intern.intern_id}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
      
    } catch (error) {
      console.error('Error loading active interns:', error);
      document.getElementById('activeInternsList').innerHTML = `
        <div class="text-center text-red-500 py-4">
          <p>‚ùå Error memuat data intern aktif</p>
          <p class="text-sm mt-2">${error.message}</p>
        </div>
      `;
    }
  }

  async function loadAttendanceData() {
    try {
      const response = await fetch(`${BACKEND_URL}/api/attendance-dates`);
      const data = await response.json();
      
      document.getElementById('totalDates').textContent = data.total_dates || 0;
      
      // Load detailed data for each date
      attendanceData = [];
      for (const date of data.dates) {
        const detailResponse = await fetch(`${BACKEND_URL}/api/attendance-by-date/${date}`);
        const detailData = await detailResponse.json();
        attendanceData.push(detailData);
      }
      
      updateAbsensiListUI();
    } catch (error) {
      console.error('Error loading attendance data:', error);
      document.getElementById('absensiList').innerHTML = `
        <div class="text-center text-red-500 py-8">
          <p>‚ùå Error memuat data</p>
          <p class="text-sm mt-2">Pastikan backend server berjalan</p>
        </div>
      `;
    }
  }

  function updateAbsensiListUI() {
    const list = document.getElementById('absensiList');
    list.innerHTML = '';

    if (attendanceData.length === 0) {
      list.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <p>üìù Belum ada data absensi</p>
          <p class="text-sm mt-2">Data akan muncul setelah ada absensi</p>
        </div>
      `;
      return;
    }

    attendanceData.forEach((data, i) => {
      const date = new Date(data.date);
      const formattedDate = date.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });

      list.innerHTML += `
        <div class="data-card p-4 rounded-lg shadow-sm">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-red-500">üìÖ</span>
              <div>
                <span class="font-medium">${formattedDate}</span>
                <p class="text-sm text-gray-500 mt-1">üë• ${data.total_attendees} peserta hadir</p>
              </div>
            </div>
            <div class="flex gap-3">
              <button onclick="viewAttendanceDetail('${data.date}')" class="action-btn text-blue-500">
                üëÅÔ∏è Lihat Detail
              </button>
            </div>
          </div>
        </div>`;
    });
  }

  function viewAttendanceDetail(date) {
    const data = attendanceData.find(d => d.date === date);
    if (!data) return;

    const dateObj = new Date(date);
    const formattedDate = dateObj.toLocaleDateString('id-ID', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });

    let detailHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Detail Absensi - ${formattedDate}</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          <div class="space-y-3">
    `;

    data.attendees.forEach(attendee => {
      detailHTML += `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full overflow-hidden">
              <img src="${attendee.photo}" alt="${attendee.name}" class="w-full h-full object-cover">
            </div>
            <div>
              <h4 class="font-medium text-gray-800">${attendee.name}</h4>
              <p class="text-sm text-gray-500">${attendee.jobdesk}</p>
              <p class="text-sm text-gray-500">‚è∞ ${new Date(attendee.recognition_time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</p>
            </div>
          </div>
          <span class="status-badge px-3 py-1 rounded-full text-sm status-hadir">${attendee.status}</span>
        </div>
      `;
    });

    detailHTML += `
          </div>
          <div class="mt-6 text-center">
            <button onclick="closeModal()" class="btn-primary">Tutup</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', detailHTML);
  }

  function closeModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
      modal.remove();
    }
  }

  function filterAbsensiList() {
    const term = document.getElementById('absensiSearchList').value.toLowerCase();
    const filtered = attendanceData.filter(data => {
      const date = new Date(data.date);
      const formattedDate = date.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }).toLowerCase();
      
      return formattedDate.includes(term) || 
             data.total_attendees.toString().includes(term) ||
             data.date.toLowerCase().includes(term) ||
             data.attendees.some(attendee => 
               attendee.name.toLowerCase().includes(term) ||
               attendee.jobdesk.toLowerCase().includes(term)
             );
    });
    
    const list = document.getElementById('absensiList');
    list.innerHTML = '';
    
    if (filtered.length === 0) {
      list.innerHTML = `
        <div class="text-center text-gray-500 py-4">
          <p>üîç Tidak ada data yang ditemukan</p>
          <p class="text-sm mt-2">Coba kata kunci pencarian yang berbeda</p>
        </div>
      `;
      return;
    }

    filtered.forEach((data, i) => {
      const date = new Date(data.date);
      const formattedDate = date.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });

      list.innerHTML += `
        <div class="data-card p-4 rounded-lg shadow-sm">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-red-500">üìÖ</span>
              <div>
                <span class="font-medium">${formattedDate}</span>
                <p class="text-sm text-gray-500 mt-1">üë• ${data.total_attendees} peserta hadir</p>
              </div>
            </div>
            <div class="flex gap-3">
              <button onclick="viewAttendanceDetail('${data.date}')" class="action-btn text-blue-500">
                üëÅÔ∏è Lihat Detail
              </button>
            </div>
          </div>
        </div>`;
    });
  }

  function showToast(message, type = "info") {
    const toast = document.createElement("div");
    toast.className = `toast ${type} p-4 rounded-lg text-white shadow-lg transform transition-all duration-300 translate-x-full`;
    toast.textContent = message;
    
    const container = document.getElementById("toastContainer");
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.remove("translate-x-full");
    }, 100);
    
    setTimeout(() => {
      toast.classList.add("translate-x-full");
      setTimeout(() => {
        container.removeChild(toast);
      }, 300);
    }, 3000);
  }

  function signOut() {
    window.location.href = "main.html";
  }

  // Auto refresh setiap 30 detik
  setInterval(() => {
    loadSystemStatus();
    loadActiveInterns(); // Refresh intern aktif setiap 30 detik
  }, 30000);
</script>

</body>
</html> 